stages:
  - build
  - test
  - deploy

# ---------------- BUILD STAGE ----------------
build_job:
  stage: build
  image: liquibase/liquibase:latest
  services:
    - name: postgres:15
      alias: db
  variables:
    POSTGRES_DB: testdb
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
  script:
    - echo "ðŸ”¨ Validating Liquibase changelogs..."
    - liquibase --url="jdbc:postgresql://db:5432/$POSTGRES_DB" --username=$POSTGRES_USER --password=$POSTGRES_PASSWORD --changelog-file=changelog.xml validate
  artifacts:
    paths:
      - build_log.txt
    expire_in: 1 week

# ---------------- TEST STAGE ----------------
test_job:
  stage: test
  image: liquibase/liquibase:latest
  services:
    - name: postgres:15
      alias: db
  variables:
    POSTGRES_DB: testdb
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
  script:
    - echo "ðŸ§ª Running Liquibase update against TEST database..."
    - liquibase --url="jdbc:postgresql://db:5432/$POSTGRES_DB" --username=$POSTGRES_USER --password=$POSTGRES_PASSWORD --changelog-file=changelog.xml update
    - echo "âœ… Test database updated successfully."
  artifacts:
    paths:
      - test_log.txt
    expire_in: 1 week

# ---------------- DEPLOY UAT ----------------
deploy_uat:
  stage: deploy
  image: liquibase/liquibase:latest
  script:
    - echo "ðŸš€ Deploying to UAT..."
    - liquibase --url="jdbc:postgresql://uat-host:5432/uatdb" --username=uat_user --password=$UAT_PASSWORD --changelog-file=changelog.xml update
    - echo "âœ… UAT deployment complete."
  when: manual
  environment:
    name: uat

# ---------------- DEPLOY PROD ----------------
deploy_prod:
  stage: deploy
  image: liquibase/liquibase:latest
  script:
    - echo "ðŸš€ Deploying to PROD..."
    - liquibase --url="jdbc:postgresql://prod-host:5432/proddb" --username=prod_user --password=$PROD_PASSWORD --changelog-file=changelog.xml update
    - echo "âœ… PROD deployment complete."
  when: manual
  environment:
    name: production
