stages:
  - build
  - test
  - deploy

# ---------------- BUILD STAGE ----------------
build_job:
  stage: build
  image: liquibase/liquibase:latest
  services:
    - name: postgres:15
      alias: db
  variables:
    POSTGRES_DB: testdb
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
  script:
    - echo "ðŸ”¨ Validating Liquibase changelogs..."
    - liquibase --url="jdbc:postgresql://db:5432/$POSTGRES_DB" \
                --username=$POSTGRES_USER --password=$POSTGRES_PASSWORD \
                --changelog-file=changelog.xml validate
  artifacts:
    paths:
      - build_log.txt
    expire_in: 1 week

# ---------------- TEST STAGE ----------------
test_job:
  stage: test
  image: liquibase/liquibase:latest
  services:
    - name: postgres:15
      alias: db
  variables:
    POSTGRES_DB: testdb
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
  script:
    - echo "ðŸ§ª Spinning up Postgres for TEST..."
    - liquibase --url="jdbc:postgresql://db:5432/$POSTGRES_DB" \
                --username=$POSTGRES_USER --password=$POSTGRES_PASSWORD \
                --changelog-file=changelog.xml update
    - echo "âœ… Running schema verification..."
    - psql -h db -U $POSTGRES_USER -d $POSTGRES_DB -c "\dt"
    - psql -h db -U $POSTGRES_USER -d $POSTGRES_DB -c "SELECT COUNT(*) FROM department;"
  artifacts:
    paths:
      - test_log.txt
    expire_in: 1 week

# ---------------- DEPLOY UAT ----------------
deploy_uat:
  stage: deploy
  image: liquibase/liquibase:latest
  script:
    - echo "ðŸš€ Deploying to UAT..."
    - liquibase --url="jdbc:postgresql://uat-db:5432/uatdb" \
                --username=$UAT_DB_USER --password=$UAT_DB_PASS \
                --changelog-file=changelog.xml update
  when: manual
  environment:
    name: uat
  allow_failure: false

# ---------------- DEPLOY PROD ----------------
deploy_prod:
  stage: deploy
  image: liquibase/liquibase:latest
  script:
    - echo "ðŸš€ Deploying to PROD..."
    - liquibase --url="jdbc:postgresql://prod-db:5432/proddb" \
                --username=$PROD_DB_USER --password=$PROD_DB_PASS \
                --changelog-file=changelog.xml update
  when: manual
  environment:
    name: production
  allow_failure: false
