stages:
  - build
  - test
  - deploy

# ---------------- BUILD STAGE ----------------
build_job:
  stage: build
  image: liquibase/liquibase:latest
  script:
    - echo "üîç Validating Liquibase changelog..." | tee build_log.txt
    # Validate the changelog syntax
    - liquibase --url="jdbc:postgresql://db:5432/testdb" \
        --username=test --password=test validate
  artifacts:
    paths:
      - build_log.txt
    expire_in: 1 week
  only:
    refs:
      - main
    changes:
      - "changelog.xml"
      - "README.md"

# ---------------- TEST STAGE ----------------
test_job:
  stage: test
  image: liquibase/liquibase:latest
  services:
    - name: postgres:15
      alias: db
  variables:
    POSTGRES_DB: testdb
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
  script:
    - echo "üß™ Applying schema in TEST database..." | tee test_log.txt
    - liquibase --url="jdbc:postgresql://db:5432/testdb" \
        --username=test --password=test update
    - echo "‚úÖ Schema applied successfully in TEST environment" | tee -a test_log.txt
    # Example check - verify tables exist
    - |
      psql -h db -U test -d testdb -c "\dt"
      psql -h db -U test -d testdb -c "SELECT * FROM department;"
  artifacts:
    paths:
      - test_log.txt
    expire_in: 1 week
  needs:
    - build_job
  only:
    refs:
      - main
    changes:
      - "changelog.xml"

# ---------------- DEPLOY TO UAT ----------------
deploy_uat:
  stage: deploy
  image: liquibase/liquibase:latest
  script:
    - echo "üöÄ Deploying schema to UAT environment..." | tee deploy_uat_log.txt
    - liquibase --url="jdbc:postgresql://uat-db:5432/uatdb" \
        --username=$UAT_DB_USER --password=$UAT_DB_PASS update
    - echo "‚úÖ UAT deployment successful!" | tee -a deploy_uat_log.txt
  artifacts:
    paths:
      - deploy_uat_log.txt
    expire_in: 1 week
  needs:
    - test_job
  when: manual   # Safe manual trigger for UAT
  allow_failure: false

# ---------------- DEPLOY TO PROD ----------------
deploy_prod:
  stage: deploy
  image: liquibase/liquibase:latest
  script:
    - echo "üöÄ Deploying schema to PROD environment..." | tee deploy_prod_log.txt
    - liquibase --url="jdbc:postgresql://prod-db:5432/proddb" \
        --username=$PROD_DB_USER --password=$PROD_DB_PASS update
    - echo "‚úÖ PROD deployment successful!" | tee -a deploy_prod_log.txt
  artifacts:
    paths:
      - deploy_prod_log.txt
    expire_in: 1 week
  needs:
    - deploy_uat
  when: manual   # Trigger manually after UAT
  allow_failure: false
