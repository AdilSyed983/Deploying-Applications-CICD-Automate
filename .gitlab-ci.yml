stages:
  - build
  - test
  - deploy

# ---------------- BUILD STAGE ----------------
build_job:
  stage: build
  image: liquibase/liquibase:latest
  script:
    - echo "ðŸ”¨ Starting build stage..."
    - echo "Validating SQL migration files with Liquibase..."
    - liquibase --changeLogFile=changelog.xml validate
  artifacts:
    paths:
      - build_log.txt
    expire_in: 1 week
  only:
    refs:
      - main
    changes:
      - "*.sql"
      - "changelog.xml"
      - "README.md"

# ---------------- TEST STAGE ----------------
test_job:
  stage: test
  image: liquibase/liquibase:latest
  services:
    - name: postgres:15
      alias: db
  variables:
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
    POSTGRES_DB: testdb
  script:
    - echo "ðŸ§ª Starting test stage..."
    - echo "Running Liquibase update against TEST DB..."
    - liquibase \
        --url=jdbc:postgresql://db:5432/testdb \
        --username=test \
        --password=test \
        --changeLogFile=changelog.xml update
  artifacts:
    paths:
      - test_log.txt
    expire_in: 1 week
  needs:
    - build_job
  only:
    refs:
      - main
    changes:
      - "*.sql"

# ---------------- DEPLOY STAGE ----------------
deploy_job:
  stage: deploy
  image: liquibase/liquibase:latest
  script:
    - echo "ðŸš€ Starting deploy stage..."
    - echo "Applying Liquibase changesets to PROD (simulation only)..."
    - liquibase \
        --url=jdbc:postgresql://prod-db:5432/proddb \
        --username=prod_user \
        --password=$PROD_DB_PASS \
        --changeLogFile=changelog.xml update
  artifacts:
    paths:
      - deploy_log.txt
    expire_in: 1 week
  needs:
    - test_job
  only:
    refs:
      - main
    changes:
      - "*.sql"
  when: manual     # safer for PROD
  allow_failure: false
